#!/usr/bin/env node
var fs = require('fs');
var util = require('util');
var FileScheme = require('../lib/filescheme');
var CopyTask = require('../lib/copytask');

var tilelive = require('../');
require('tilelive-mapnik').registerProtocols(tilelive);
require('bigtiles').registerProtocols(tilelive);

var optimist = require('optimist');
var argv = optimist
    .describe('state', 'State file')
    .describe('scheme', 'One of [file, scanline, pyramid]')
    .describe('from', 'Source URL')
    .describe('to', 'Destination URL')
    .describe('list', 'If scheme=file, the filename containing the coordinates to render')
    .argv;


if (argv.state) {
    var state = JSON.parse(fs.readFileSync(argv.state, 'utf8'));
    var task = CopyTask.unserialize(state);
} else {
    argv = optimist
        .demand('from')
        .demand('to')
        .demand('list')
        .argv;

    var scheme = new FileScheme({
        filename: argv.list,
        concurrency: 8
    });
    var task = new CopyTask(argv.from, argv.to, scheme);
}

report();
task.on('load', task.start);

task.on('progress', report);

task.on('finished', function() {
    console.warn('\nfinished');
});

task.on('error', function(err) {
    util.print('\r\033[K');
    console.warn(err.stack);
    report();
});


function report() {
    var stats = task.stats;
    util.print('\r\033[K');
    util.print('copied: ' + stats.processed + '/' + stats.total);
    util.print('\tspeed: ' + stats.speed + '/s');
    util.print('\tremaining: ' + stats.remaining);
    util.print('\tunique: ' + stats.unique);
    util.print('\tdupes: ' + stats.duplicate);
    util.print('\tskipped: ' + stats.skipped);
    util.print('\tfailed: ' + stats.failed);
}
